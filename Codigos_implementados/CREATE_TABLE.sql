--Creacion de tablas
CREATE TABLE Estado_Ejemplar (
    ID_Estado NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    Estado VARCHAR2(50) NOT NULL
);

CREATE TABLE Estado_Multa (
    ID_Estado NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    Estado VARCHAR2(20) DEFAULT 'Pendiente' NOT NULL
);

CREATE TABLE Estado_Pedido (
    ID_Estado NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    Estado VARCHAR2(20) DEFAULT 'Pendiente' NOT NULL
);

CREATE TABLE Usuario (
    ID_Usuario NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    Nombre VARCHAR2(100) NOT NULL,
    Direccion VARCHAR2(200),
    Telefono VARCHAR2(20),
    Email VARCHAR2(100) UNIQUE NOT NULL,
    Fecha_Registro DATE NOT NULL
);

CREATE TABLE Categoria (
    ID_Categoria NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    Nombre_Categoria VARCHAR2(50) NOT NULL
);

CREATE TABLE Editorial (
    ID_Editorial NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    Nombre VARCHAR2(50) NOT NULL
);

CREATE TABLE Sucursal (
    ID_Sucursal NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    Nombre_Sucursal VARCHAR2(100) NOT NULL,
    Direccion VARCHAR2(200),
    Telefono VARCHAR2(20)
);

CREATE TABLE Libro (
    ID_Libro NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    Titulo VARCHAR2(200) NOT NULL,
    ID_Categoria NUMBER NOT NULL,
    ID_Editorial NUMBER NOT NULL,
    FOREIGN KEY (ID_Categoria) REFERENCES Categoria(ID_Categoria),
    FOREIGN KEY (ID_Editorial) REFERENCES Editorial(ID_Editorial)
);

CREATE TABLE Ejemplar (
    ID_Ejemplar NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    ID_Libro NUMBER NOT NULL,
    Estado_ID NUMBER NOT NULL,
    ID_Sucursal NUMBER NOT NULL,
    FOREIGN KEY (ID_Libro) REFERENCES Libro(ID_Libro),
    FOREIGN KEY (Estado_ID) REFERENCES Estado_Ejemplar(ID_Estado),
    FOREIGN KEY (ID_Sucursal) REFERENCES Sucursal(ID_Sucursal)
);

CREATE TABLE Bibliotecario (
    ID_Bibliotecario NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    Nombre VARCHAR2(100) NOT NULL,
    Email VARCHAR2(100) UNIQUE NOT NULL,
    Telefono VARCHAR2(20)
);

CREATE TABLE Prestamo (
    ID_Prestamo NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    ID_Usuario NUMBER NOT NULL,
    ID_Ejemplar NUMBER NOT NULL,
    ID_Bibliotecario NUMBER NOT NULL,
    Fecha_Alquiler DATE NOT NULL,
    Fecha_Devolucion DATE NOT NULL,
    Devuelto CHAR(1) DEFAULT 'N' CHECK (Devuelto IN ('Y', 'N')),
    FOREIGN KEY (ID_Usuario) REFERENCES Usuario(ID_Usuario),
    FOREIGN KEY (ID_Ejemplar) REFERENCES Ejemplar(ID_Ejemplar),
    FOREIGN KEY (ID_Bibliotecario) REFERENCES Bibliotecario(ID_Bibliotecario)
);

CREATE TABLE Historial_Prestamos (
    ID_Historial NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    ID_Prestamo NUMBER NOT NULL,
    Estado VARCHAR2(50) NOT NULL,
    Fecha_Cambio DATE DEFAULT SYSDATE NOT NULL,
    FOREIGN KEY (ID_Prestamo) REFERENCES Prestamo(ID_Prestamo)
);

CREATE TABLE Multa (
    ID_Multa NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    ID_Usuario NUMBER NOT NULL,
    ID_Prestamo NUMBER NOT NULL,
    Monto NUMBER(10,2) NOT NULL,
    Estado_ID NUMBER DEFAULT 1,
    Fecha_Pago DATE,
    FOREIGN KEY (ID_Usuario) REFERENCES Usuario(ID_Usuario),
    FOREIGN KEY (ID_Prestamo) REFERENCES Prestamo(ID_Prestamo),
    FOREIGN KEY (Estado_ID) REFERENCES Estado_Multa(ID_Estado)
);

CREATE TABLE Pedido (
    ID_Pedido NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    ID_Usuario NUMBER NOT NULL,
    Fecha_Pedido DATE NOT NULL,
    Total NUMBER(10,2) NOT NULL,
    Estado_ID NUMBER DEFAULT 1,
    FOREIGN KEY (ID_Usuario) REFERENCES Usuario(ID_Usuario),
    FOREIGN KEY (Estado_ID) REFERENCES Estado_Pedido(ID_Estado)
);

CREATE TABLE Autor (
    ID_Autor NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    Nombre VARCHAR2(100) NOT NULL
);


CREATE TABLE Libro_Autor (
    ID_Libro NUMBER NOT NULL,
    ID_Autor NUMBER NOT NULL,
    PRIMARY KEY (ID_Libro, ID_Autor),
    FOREIGN KEY (ID_Libro) REFERENCES Libro(ID_Libro),
    FOREIGN KEY (ID_Autor) REFERENCES Autor(ID_Autor)
);

CREATE TABLE Pago (
    ID_Pago NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    ID_Pedido NUMBER NOT NULL,
    Monto NUMBER(10,2) NOT NULL,
    Fecha_Pago DATE NOT NULL,
    Metodo_Pago VARCHAR2(50) NOT NULL CHECK (Metodo_Pago IN ('Tarjeta', 'Efectivo', 'Transferencia')),
    Estado_Pago VARCHAR2(20) DEFAULT 'Pendiente' CHECK (Estado_Pago IN ('Pendiente', 'Completado', 'Rechazado')),
    FOREIGN KEY (ID_Pedido) REFERENCES Pedido(ID_Pedido)
);
